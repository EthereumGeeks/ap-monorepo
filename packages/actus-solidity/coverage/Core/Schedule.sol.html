<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for Core/Schedule.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">Core/</a> Schedule.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">97.37% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>37/38</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">90.63% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>29/32</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>2/2</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">97.22% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>35/36</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1054×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1054×</span>
<span class="cline-any cline-yes">174×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">69×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">687×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">77×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">28×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">19×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1054×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">108×</span>
<span class="cline-any cline-yes">108×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">108×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">101×</span>
<span class="cline-any cline-yes">101×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">101×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1029×</span>
<span class="cline-any cline-yes">957×</span>
<span class="cline-any cline-yes">957×</span>
<span class="cline-any cline-yes">957×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1029×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1029×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">101×</span>
<span class="cline-any cline-yes">83×</span>
<span class="cline-any cline-yes">79×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">101×</span>
<span class="cline-any cline-yes">101×</span>
<span class="cline-any cline-yes">30×</span>
<span class="cline-any cline-yes">30×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">101×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">pragma solidity ^0.6.4;
pragma experimental ABIEncoderV2;
&nbsp;
import "../external/BokkyPooBah/BokkyPooBahsDateTimeLibrary.sol";
&nbsp;
import "./ACTUSTypes.sol";
import "./Utils.sol";
&nbsp;
&nbsp;
/**
 * @title Schedule
 * @notice Methods related to generating event schedules.
 */
contract Schedule is ACTUSTypes, Utils {
&nbsp;
    /**
     * @notice Applies the cycle n - times (n := cycleIndex) to a given date
     */
    function getNextCycleDate(IPS memory cycle, uint256 cycleStart, uint256 cycleIndex)
        internal
        pure
        returns (uint256)
    {
        uint256 newTimestamp;
&nbsp;
        if (cycle.p == P.D) {
            newTimestamp = BokkyPooBahsDateTimeLibrary.addDays(cycleStart, cycle.i * cycleIndex);
        } else if (cycle.p == P.W) {
            newTimestamp = BokkyPooBahsDateTimeLibrary.addDays(cycleStart, cycle.i * 7 * cycleIndex);
        } else if (cycle.p == P.M) {
            newTimestamp = BokkyPooBahsDateTimeLibrary.addMonths(cycleStart, cycle.i * cycleIndex);
        } else if (cycle.p == P.Q) {
            newTimestamp = BokkyPooBahsDateTimeLibrary.addMonths(cycleStart, cycle.i * 3 * cycleIndex);
        } else if (cycle.p == P.H) {
            newTimestamp = BokkyPooBahsDateTimeLibrary.addMonths(cycleStart, cycle.i * 6 * cycleIndex);
        } else <span class="missing-if-branch" title="else path not taken" >E</span>if (cycle.p == P.Y) {
            newTimestamp = BokkyPooBahsDateTimeLibrary.addYears(cycleStart, cycle.i * cycleIndex);
        } else {
<span class="cstat-no" title="statement not covered" >            revert("Schedule.getNextCycleDate: ATTRIBUTE_NOT_FOUND")</span>;
        }
&nbsp;
        return newTimestamp;
    }
&nbsp;
    /**
     * This function computes an array of UNIX timestamps that
     * represent dates in a cycle falling within a given segment.
     * @dev There are some notable edge cases: If the cycle is "not set" we return the start end end dates
     * of the cycle if they lie within the segment. Otherwise and empty array is returned.
     * @param cycleStart the start time of the cycle
     * @param cycleEnd the end time of the cycle
     * @param cycle struct that describe sthe cycle
     * @param addEndTime specifies if the timestamp of the end of the cycle should be added to the result if it falls in the segment
     * @param segmentStart start time of the segment
     * @param segmentEnd end time of the segment
     * @return an array of timestamps from the given cycle that fall within the specified segement
     */
    function computeDatesFromCycleSegment(
        uint256 cycleStart,
        uint256 cycleEnd,
        IPS memory cycle,
        bool addEndTime,
        uint256 segmentStart,
        uint256 segmentEnd
    )
        internal
        pure
        returns (uint256[MAX_CYCLE_SIZE] memory)
    {
        uint256[MAX_CYCLE_SIZE] memory dates;
        uint256 index = 0;
&nbsp;
        // if the cycle is not set we return only the cycle start end end dates under these conditions:
        // we return the cycle start, if it's in the segment
        // in case of addEntTime = true, the cycle end is also returned if in the segment
        if (cycle.isSet == false) {
            if (isInSegment(cycleStart, segmentStart, segmentEnd)) {
                dates[index] = cycleStart;
                index++;
            }
            if (isInSegment(cycleEnd, segmentStart, segmentEnd)) {
                if (addEndTime == true) dates[index] = cycleEnd;
            }
            return dates;
        }
&nbsp;
        uint256 date = cycleStart;
        uint256 cycleIndex = 0;
&nbsp;
        // walk through the cycle and create the cycle dates to be returned
        while (date &lt; cycleEnd) {
            // if date is in segment and MAX_CYCLE_SIZE is not reached add it to the output array
            if (isInSegment(date, segmentStart, segmentEnd)) {
                <span class="missing-if-branch" title="else path not taken" >E</span>require(index &lt; (MAX_CYCLE_SIZE - 2), "Schedule.computeDatesFromCycle: MAX_CYCLE_SIZE");
                dates[index] = date;
                index++;
            }
&nbsp;
            cycleIndex++;
&nbsp;
&nbsp;
            date = getNextCycleDate(cycle, cycleStart, cycleIndex);
&nbsp;
        }
&nbsp;
        // add additional time at the end if addEndTime
        if (addEndTime == true) {
            if (isInSegment(cycleEnd, segmentStart, segmentEnd)) {
                dates[index] = cycleEnd;
            }
        }
&nbsp;
        // handle a special case where S is set to LONG (e.g. for trimming a cycle to the maturity date)
        <span class="missing-if-branch" title="else path not taken" >E</span>if (index &gt; 0 &amp;&amp; isInSegment(dates[index - 1], segmentStart, segmentEnd)) {
            if (cycle.s == S.LONG &amp;&amp; index &gt; 1 &amp;&amp; cycleEnd != date) {
                dates[index - 1] = dates[index];
                delete dates[index];
            }
        }
&nbsp;
        return dates;
    }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Mon Apr 20 2020 19:41:12 GMT+0200 (GMT+02:00)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
